extends layout 

block content 
    // Search bar
    .row.justify-content-left.align-items-top 
        .col-lg-8
            form#latin-search(method="GET", action="/latin")
                // On submit, calls endpoint '/latin' with query params {search: 'input field val', submit: 'normal'}
                // viz. query params are equal to key-value pairs using 'name' and 'value' attributes of input & btn elements

                .input-group.mb-3
                    //label.input-group-text(for="search-input") Meaning
                    //Populate with currently displayed lemma if exists
                    input.form-control.alt-keys#search-input(type="text", name="search", placeholder="Enter a query", value=lemmaData ? lemmaData.main.lemma : '')
                    #alt-letter-popover(style="display: none;")
                    button.btn.btn-success(type="submit", name='submit', value="normal") Search

    // Details display
    // Grammar data comes from main entry
    if lemmaData
        #entry-details
            #details-table
                table 
                    tr
                        td Language 
                        td #{lemmaData.main.lang}
                    tr
                        td Grammar 
                        if lemmaData.main.gender
                            td #{lemmaData.main.pos}, #{lemmaData.main.gender}
                        else
                            td #{lemmaData.main.pos}
                    tr
                        td Pronunciation 
                        td #{lemmaData.main.ipa}
                    tr
                        td Etymology
                        td#details-etymology
                    tr
                        td Cognates
                        td#details-cognates
                    tr
                        td Descendants
                        td *offspring here*
            
            hr
            #details-meaning
                h5 Meaning
                #senses
                    // Populated later
                
            hr
            #details-declension
                h5 Declension
                p *Latin quiz flashbacks here*
                
            hr
            #details-citations
                h5 Attestations
                ul#citations
                    //Populated later
            
            hr
            #details-related
                h5 Related Words
                if lemmaData.related
                    ul
                        each entry in lemmaData.related
                            li
                                a(href="/latin/lemma/" + entry.lemma_id) #{entry.lemma + (entry.sense_num ? entry.sense_num.split('.')[0] : '')}
                    
        script.
            const INDENT_PX = 50;
            // Number of entries/attestations to show before adding 'show more' button
            const SENSES_BEFORE_TRUNC = 0; // Show main entry, but no add'l senses
            const ATTEST_BEFORE_TRUNC = 5;
            const ETYM_BEFORE_TRUNC = 1;
            const COGN_BEFORE_TRUNC = 5;

            // Populate entries & attestations
            let data = !{JSON.stringify(lemmaData)};
            let entries = data.senses;
            let mainEntry = data.main;
            let attestations = [];
            const senseParent = document.getElementById('senses');
            const attestationParent = document.getElementById('citations');

            // Function for populating content with 'show more' button
            function withShowMore(elements, parent, before_hide, do_inline = false, overrideID = null) {
                if (!parent.id && !overrideID) {
                    console.error("Parent element has no id! " + parent);
                    return;
                }
                let hiddenDivId = parent.id + '-show-more';
                
                elements.slice(0, before_hide).forEach((elem) => {
                    parent.appendChild(elem);
                    if (do_inline) {
                        parent.innerHTML += ', ';
                    }
                })

                // Add 'show more' button & hidden div with remaining entries
                if (elements.length > before_hide) {
                    let showMoreBtn = document.createElement('button');
                    showMoreBtn.classList.add('show-more-btn');
                    showMoreBtn.innerText = '... (click to expand)';
                    showMoreBtn.addEventListener('click', function(e) {
                        if (
                            document.getElementById(hiddenDivId).classList.toggle('hidden')
                        ) {
                            e.target.innerText = '... (click to expand)'
                        } else {
                            e.target.innerText = '(click to collapse)'
                        }
                    });
                    parent.appendChild(showMoreBtn);

                    // Create div for hidden entries
                    let hiddenDiv = document.createElement('div');
                    hiddenDiv.id = hiddenDivId;
                    hiddenDiv.classList.add('hidden');
                    if (do_inline) {
                        hiddenDiv.classList.add = 'inline';
                    }
                    
                    elements.slice(before_hide).forEach((elem) => {
                        hiddenDiv.appendChild(elem);
                            if (do_inline) {
                                hiddenDiv.innerHTML += ', ';
                            }
                    });
                    // Remove trailing comma
                    hiddenDiv.innerHTML = hiddenDiv.innerHTML.replace(/, $/, '');

                    parent.appendChild(hiddenDiv);
                } else {
                    // Remove trailing comma
                    parent.innerHTML = parent.innerHTML.replace(/, $/, '');
                }
            }

            // Etymology field
            if (data.etym) {
                let etymElements = []
                data.etym.forEach((etym) => {
                    let etymDiv = document.createElement('div');
                    etymDiv.classList.add('etym');
                    etymDiv.innerHTML = `from PIE <i>${etym.rt_shape}</i> '${etym.rt_gloss_orig}' (${etym.ref_id})`
                    etymElements.push(etymDiv);
                })
                withShowMore(etymElements, document.getElementById('details-etymology'), ETYM_BEFORE_TRUNC);
            }
            // Cognates field
            if (data.cognates) {
                let cognateElements = []
                data.cognates.forEach((c) => {
                    let cognateEl = document.createElement('span');
                    cognateEl.classList.add('cognate');
                    cognateEl.innerHTML = `<span style='text-transform: capitalize;'>${c.orig_lang_abbrev}</span> <i>${c.reflex}</i>`
                    if (c.gloss_eng) {
                        cognateEl.innerHTML += ` '${c.gloss_eng}'`
                    }
                    cognateElements.push(cognateEl);
                })
                withShowMore(cognateElements, document.getElementById('details-cognates'), COGN_BEFORE_TRUNC, true);
            }

            // Main sense entry
            let mainDiv = document.createElement('div');
            mainDiv.classList.add('main-sense', 'sense');
            if (mainEntry.sense_num) {
                mainDiv.innerHTML += "<b>" + mainEntry.sense_num + ". </b>"
            }
            mainDiv.innerHTML += "<span>" + (mainEntry.entry ? mainEntry.entry : mainEntry.entry_str) + "</span>"
            senseParent.appendChild(mainDiv);
            mainDiv.querySelectorAll('.cit, :not(.cit) > .bibl').forEach((elem) => {
                    attestations.push(elem.cloneNode(true));
                });

            //Sense entries
            function createSenseDiv(sense) {
                let entryDiv = document.createElement('div');
                let indent_lvl = Math.floor((sense.sense_num.split('.').length - 1) / 2);
                entryDiv.classList.add('sense', 'indent-' + indent_lvl);
                entryDiv.style = "margin-left:" + (INDENT_PX*indent_lvl) + "px;";
                entryDiv.innerHTML += "<b>" + sense.sense_num.split('.').at(-1) + ". </b>"
                entryDiv.innerHTML += "<span>" + (sense.entry ? sense.entry : sense.entry_str) + "</span>"

                entryDiv.querySelectorAll('.cit, :not(.cit) > .bibl').forEach((elem) => {
                    attestations.push(elem.cloneNode(true));
                });

                return entryDiv
            }
            let entryElements = [];
            entries.forEach((sense) => {
                entryElements.push(createSenseDiv(sense));
            });
            withShowMore(entryElements, senseParent, SENSES_BEFORE_TRUNC);
            
            
            // Populate attestations
            attestationElements = []
            attestations.forEach((elem) => {
                attestationElement = document.createElement('li');
                attestationElement.appendChild(elem);
                //Indent if no author listed (belongs to previous work?) - cf. acus[2]
                //Could compare URN attribute here if needed
                if (!elem.querySelector('.author')) {
                    attestationElement.style = "margin-left:" + INDENT_PX/2 + "px;";
                }
                attestationElements.push(attestationElement);
            });
            withShowMore(attestationElements, attestationParent, ATTEST_BEFORE_TRUNC);